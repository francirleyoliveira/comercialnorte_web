<!DOCTYPE html>
<html>
<head>
    <title>Monitor do Connection Pool</title>
    <style>
        body { 
            font-family: Arial; 
            padding: 20px; 
            background: #f5f5f5;
            margin: 0;
        }
        .header {
            background: #007bff;
            color: white;
            padding: 20px;
            margin: -20px -20px 20px -20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header h1 {
            margin: 0;
            font-size: 24px;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin: 10px 0; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .stat { 
            display: inline-block; 
            margin: 10px 20px;
            text-align: center;
            min-width: 150px;
        }
        .stat-value { 
            font-size: 2.5em; 
            font-weight: bold; 
            color: #007bff;
            transition: color 0.3s ease;
        }
        .stat-label { 
            color: #666;
            font-size: 0.9em;
            margin-top: 5px;
        }
        .good { color: #28a745; }
        .warning { color: #ffc107; }
        .danger { color: #dc3545; }
        
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .alerts {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
        }
        .alert {
            padding: 10px 20px;
            border-radius: 4px;
            margin-bottom: 10px;
            animation: slideIn 0.3s ease;
            color: white;
        }
        .alert.error { background: #dc3545; }
        .alert.warning { background: #ffc107; color: #000; }
        .alert.info { background: #007bff; }
        
        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            body { background: #1a1a1a; color: #fff; }
            .card { background: #2d2d2d; color: #fff; }
            .stat-label { color: #ccc; }
            .header { background: #004085; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <h1>üîç Monitor do Connection Pool</h1>
        </div>
    </div>

    <div class="container">
        <div id="alerts" class="alerts"></div>

        <div class="grid">
            <div class="card">
                <h2>Status Atual</h2>
                <div class="stat">
                    <div class="stat-value" id="open">-</div>
                    <div class="stat-label">Conex√µes Abertas</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="inUse">-</div>
                    <div class="stat-label">Em Uso</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="queue">-</div>
                    <div class="stat-label">Na Fila</div>
                </div>
            </div>

            <div class="card">
                <h2>M√©tricas de Performance</h2>
                <div class="stat">
                    <div class="stat-value" id="avgResponse">-</div>
                    <div class="stat-label">Tempo M√©dio (ms)</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="rps">-</div>
                    <div class="stat-label">Requisi√ß√µes/s</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="errorRate">-</div>
                    <div class="stat-label">Taxa de Erro</div>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>Configura√ß√£o do Pool</h2>
            <div class="grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                <div>
                    <h3>B√°sico</h3>
                    <p><strong>M√≠nimo:</strong> <span id="min">-</span></p>
                    <p><strong>M√°ximo:</strong> <span id="max">-</span></p>
                    <p><strong>Incremento:</strong> <span id="increment">-</span></p>
                </div>
                <div>
                    <h3>Timeouts</h3>
                    <p><strong>Pool:</strong> <span id="timeout">-</span></p>
                    <p><strong>Fila:</strong> <span id="queueTimeout">-</span></p>
                </div>
                <div>
                    <h3>Status</h3>
                    <p><strong>Utiliza√ß√£o:</strong> <span id="utilization">-</span></p>
                    <p><strong>Sa√∫de:</strong> <span id="health">-</span></p>
                </div>
            </div>
        </div>

    <div class="card">
        <h2>Hist√≥rico (√∫ltimos 30 segundos)</h2>
        <canvas id="chart" width="800" height="200"></canvas>
    </div>

    <script>
        // Configura√ß√µes
        const HISTORY_SIZE = 30;
        const UPDATE_INTERVAL = 1000;
        const ALERT_TIMEOUT = 5000;

        // Estado do monitor
        const state = {
            history: {
                open: [],
                inUse: [],
                queue: [],
                rps: [],
                responseTime: [],
                timestamps: []
            },
            metrics: {
                totalRequests: 0,
                errors: 0,
                lastUpdate: Date.now()
            }
        };

        function showAlert(message, type = 'info') {
            const alertsDiv = document.getElementById('alerts');
            const alert = document.createElement('div');
            alert.className = `alert ${type}`;
            alert.textContent = message;
            alertsDiv.appendChild(alert);
            
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, ALERT_TIMEOUT);
        }

        function updateMetrics(data) {
            const now = Date.now();
            const deltaTime = (now - state.metrics.lastUpdate) / 1000;
            const rps = data.requestsProcessed ? (data.requestsProcessed / deltaTime).toFixed(2) : '0';
            
            document.getElementById('rps').textContent = rps;
            document.getElementById('avgResponse').textContent = data.averageResponseTime?.toFixed(2) || '-';
            document.getElementById('errorRate').textContent = 
                ((state.metrics.errors / state.metrics.totalRequests) * 100 || 0).toFixed(1) + '%';
            
            state.metrics.lastUpdate = now;
        }

        function checkAlerts(data) {
            const utilization = data.pool.inUse / data.pool.poolMax;
            
            if (utilization > 0.9) {
                showAlert('‚ö†Ô∏è Pool pr√≥ximo da capacidade m√°xima!', 'warning');
            }
            
            if (data.pool.queueLength > 10) {
                showAlert('üö® Muitas requisi√ß√µes na fila!', 'error');
            }
            
            if (data.averageResponseTime > 1000) {
                showAlert('‚ö†Ô∏è Tempo de resposta alto!', 'warning');
            }
        }

        async function updateStats() {
            try {
                const response = await fetch('/api/pool-status');
                const data = await response.json();
                
                // Atualiza valores b√°sicos
                document.getElementById('open').textContent = data.pool.connectionsOpen;
                document.getElementById('inUse').textContent = data.pool.connectionsInUse;
                document.getElementById('queue').textContent = data.pool.queueLength || 0;
                
                // Configura√ß√£o
                document.getElementById('min').textContent = data.pool.poolMin;
                document.getElementById('max').textContent = data.pool.poolMax;
                document.getElementById('increment').textContent = data.pool.poolIncrement;
                document.getElementById('timeout').textContent = data.pool.poolTimeout + 's';
                document.getElementById('queueTimeout').textContent = data.pool.queueTimeout;
                
                // M√©tricas calculadas
                const utilization = ((data.pool.connectionsInUse / data.pool.poolMax) * 100).toFixed(1) + '%';
                document.getElementById('utilization').textContent = utilization;
                
                const health = data.pool.connectionsOpen <= data.pool.poolMax ? 'Saud√°vel' : 'Sobrecarregado';
                const healthEl = document.getElementById('health');
                healthEl.textContent = health;
                healthEl.className = health === 'Saud√°vel' ? 'good' : 'danger';
                
                // Aplica cores
                const inUseEl = document.getElementById('inUse');
                const usage = data.pool.inUse / data.pool.poolMax;
                if (usage < 0.5) {
                    inUseEl.className = 'stat-value good';
                } else if (usage < 0.8) {
                    inUseEl.className = 'stat-value warning';
                } else {
                    inUseEl.className = 'stat-value danger';
                }
                
                // Atualiza hist√≥rico
                const now = new Date().toLocaleTimeString();
                history.open.push(data.pool.open);
                history.inUse.push(data.pool.inUse);
                history.timestamps.push(now);
                
                // Mant√©m apenas √∫ltimos 30 pontos
                if (history.open.length > 30) {
                    history.open.shift();
                    history.inUse.shift();
                    history.timestamps.shift();
                }
                
                drawChart();
                
            } catch (err) {
                console.error('Erro ao atualizar stats:', err);
            }
        }

        function drawChart() {
            const canvas = document.getElementById('chart');
            const ctx = canvas.getContext('2d');
            const width = canvas.width;
            const height = canvas.height;
            
            // Limpa canvas
            ctx.clearRect(0, 0, width, height);
            
            if (history.open.length === 0) return;
            
            // Configura√ß√µes
            const padding = 40;
            const chartWidth = width - 2 * padding;
            const chartHeight = height - 2 * padding;
            const maxValue = Math.max(...history.open, 10);
            
            // Desenha eixos
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, height - padding);
            ctx.lineTo(width - padding, height - padding);
            ctx.stroke();
            
            // Desenha grade
            for (let i = 0; i <= 5; i++) {
                const y = padding + (chartHeight / 5) * i;
                ctx.strokeStyle = '#f0f0f0';
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(width - padding, y);
                ctx.stroke();
                
                // Labels
                ctx.fillStyle = '#666';
                ctx.font = '12px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(Math.round(maxValue * (1 - i / 5)), padding - 10, y + 4);
            }
            
            // Desenha linhas
            const stepX = chartWidth / (history.open.length - 1 || 1);
            
            // Linha "Abertas"
            ctx.strokeStyle = '#007bff';
            ctx.lineWidth = 2;
            ctx.beginPath();
            history.open.forEach((val, i) => {
                const x = padding + i * stepX;
                const y = padding + chartHeight - (val / maxValue) * chartHeight;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // Linha "Em Uso"
            ctx.strokeStyle = '#28a745';
            ctx.lineWidth = 2;
            ctx.beginPath();
            history.inUse.forEach((val, i) => {
                const x = padding + i * stepX;
                const y = padding + chartHeight - (val / maxValue) * chartHeight;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
            
            // Legenda
            ctx.font = '14px Arial';
            ctx.fillStyle = '#007bff';
            ctx.fillText('‚ñ† Conex√µes Abertas', width - 200, 30);
            ctx.fillStyle = '#28a745';
            ctx.fillText('‚ñ† Em Uso', width - 200, 50);
        }

        // Atualiza a cada 1 segundo
        updateStats();
        setInterval(updateStats, 1000);
    </script>
</body>
</html>